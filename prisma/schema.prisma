// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "mysql"
}

enum Currency {
  BDT
}

enum PaymentMethod {
  BKASH
}

enum PaymentStatus {
  PENDING
  AUTHORIZED
  CAPTURED
  FAILED
  REFUNDED
}

enum OrderStatus {
  PLACED
  PAID
  SHIPPED
  DELIVERED
  CANCELED
  RETURNED
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum RoleName {
  SuperAdmin
  Admin
  Manager
  SupportStaff
  InventoryStaff
  MarketingStaff
  Customer
}

model User {
  id           String   @id @default(cuid())
  email        String?  @unique
  phone        String?  @unique
  name         String?
  zensaiId     String   @unique
  language     String   @default("en")
  twoFAEnabled Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  addresses    Address[]
  orders       Order[]
  cart         Cart?
  wishlist     WishlistItem[]
  loyalty      LoyaltyLedger[]
  roles        UserRole[]
  staff        Staff?
  messages     Message[]
  tickets      Ticket[]
  notifications Notification[]
  auditLogs    AuditLog[] @relation("AuditActor")
}

model Address {
  id        String   @id @default(cuid())
  userId    String
  line1     String
  line2     String?
  city      String
  state     String?
  postal    String?
  country   String  @default("BD")
  isDefault Boolean @default(false)
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Product {
  id          String   @id @default(cuid())
  slug        String   @unique
  name        String
  description String?
  category    String?
  status      String   @default("ACTIVE")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  variants    Variant[]
  wishlist    WishlistItem[]
}

model Variant {
  id         String   @id @default(cuid())
  productId  String
  sku        String   @unique
  size       String?
  color      String?
  priceMinor Int
  currency   Currency @default(BDT)
  stock      Int      @default(0)

  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  inventory  InventoryTransaction[]
  orderItems OrderItem[]
  cartItems  CartItem[]
}

model Supplier {
  id           String   @id @default(cuid())
  name         String
  contact      String?
  leadTimeDays Int? 
  createdAt    DateTime @default(now())

  inventory    InventoryTransaction[]
}

model InventoryTransaction {
  id         String   @id @default(cuid())
  variantId  String
  supplierId String?
  delta      Int
  reason     String?
  createdAt  DateTime @default(now())

  variant    Variant   @relation(fields: [variantId], references: [id], onDelete: Cascade)
  supplier   Supplier? @relation(fields: [supplierId], references: [id])
}

model Order {
  id           String      @id @default(cuid())
  userId       String
  status       OrderStatus @default(PLACED)
  totalMinor   Int
  currency     Currency    @default(BDT)
  paymentId    String?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  user         User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  items        OrderItem[]
  payment      Payment?    @relation(fields: [paymentId], references: [id])
}

model OrderItem {
  id         String  @id @default(cuid())
  orderId    String
  variantId  String
  qty        Int
  priceMinor Int

  order      Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  variant    Variant @relation(fields: [variantId], references: [id], onDelete: Restrict)
}

model Cart {
  id        String   @id @default(cuid())
  userId    String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  items     CartItem[]
}

model CartItem {
  id        String  @id @default(cuid())
  cartId    String
  variantId String
  qty       Int     @default(1)

  cart      Cart    @relation(fields: [cartId], references: [id], onDelete: Cascade)
  variant   Variant @relation(fields: [variantId], references: [id], onDelete: Restrict)
}

model WishlistItem {
  id        String  @id @default(cuid())
  userId    String
  productId String
  createdAt DateTime @default(now())

  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
}

model Payment {
  id           String        @id @default(cuid())
  method       PaymentMethod
  status       PaymentStatus @default(PENDING)
  amountMinor  Int
  currency     Currency      @default(BDT)
  idempotencyKey String?     @unique
  providerRef  String?
  createdAt    DateTime      @default(now())

  order        Order?
}

model Promotion {
  id           String   @id @default(cuid())
  code         String   @unique
  discountPercent Int?
  discountMinor Int?
  validFrom    DateTime?
  validTo      DateTime?
  usageLimit   Int?
  usedCount    Int       @default(0)
  createdAt    DateTime  @default(now())
}

model LoyaltyLedger {
  id        String   @id @default(cuid())
  userId    String
  type      String   // earn/redeem
  points    Int
  note      String?
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Message {
  id        String   @id @default(cuid())
  userId    String
  content   String
  createdAt DateTime @default(now())
  encrypted Boolean  @default(true)

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Ticket {
  id            String        @id @default(cuid())
  userId        String
  status        TicketStatus  @default(OPEN)
  priority      TicketPriority @default(MEDIUM)
  assignedStaffId String?
  subject       String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  assignedStaff Staff?        @relation(fields: [assignedStaffId], references: [id])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String   // delivery, promotion, etc.
  channel   String   // email, sms, push
  status    String   // queued, sent, failed
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Role {
  id    String   @id @default(cuid())
  name  RoleName @unique
  users UserRole[]
}

model UserRole {
  id     String  @id @default(cuid())
  userId String
  roleId String

  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  role   Role    @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
}

model Staff {
  id        String   @id @default(cuid())
  userId    String   @unique
  roleId    String
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role      Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
}

model AuditLog {
  id           String   @id @default(cuid())
  actorUserId  String
  action       String
  targetType   String
  targetId     String?
  metadata     Json?
  createdAt    DateTime @default(now())

  actor        User     @relation("AuditActor", fields: [actorUserId], references: [id], onDelete: Cascade)
}
